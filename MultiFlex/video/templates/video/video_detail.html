{% extends "base.html" %}
{% load widget_tweaks %} 

{% block title %}video_detail.html{% endblock %}
{% block extra-style %}
    <style>       
        .video1{
            position : fixed;
            top : 100px;
        }
        #guard{
            height : 20px;


            
        }
        .layer1{
            position : relative;
        
        }

        #absolute{
            position: absolute;
            top:0px;
            left:1000px;
        }

    </style>
    
{% endblock %}


{% block content %}

    
<div class='container full-width'>
    <div>
        <iframe width="1000" height="480" src="{{ video.video_link }}" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>
    </div>
    <div class="form-row float-right">
        <input type="button" class="btn btn-info btn-sm like" name="{{video.video_id}}" value="좋아요 {{video.recommend.all.count}}개">
        <input type="button" class="btn btn-info btn-sm dibs" name="{{video.video_id}}" value="{{how_dib}}">
    </div>
    
    <div id='absolute'>
    {% for review in page_obj %}
    <h1>
        <li><a href='#'>{{review.re_title}} </a></li>
    </h1>
    (작성자 : {{review.user_id}})
    {{review.content|safe}}
        <button type="button" class="btn btn-info btn-sm">
            <a href="/review/{{ review.id }}/updateReview/">수정</a>
        </button>
        <button type="button" class="btn btn-danger btn-sm"> 
            <a href="/review/{{ review.id }}/deleteReview/">삭제</a>
        </button>
    {% endfor %}
    
    <br><br>
    <div>
        <span>
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}">PreviousPage</a>
            {% endif %}
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">NextPage</a>
            {% endif %}
        </span>
    </div>
    </div>

    <br><br>
    <!-- 여기서 부터 리뷰작성 부분 -->
    
    <div class="container">
        <h4>리뷰를 남겨주세요.</h4>
    {% if form.errors %} 
        <div class="alert alert-danger"> 
            <div class="font-weight-bold">
                Wrong! Please correct the error(s) below.</div> 
            {{ form.errors }} 
        </div> 
        {% endif %}
        <form action="." method="post" enctype="multipart/form-data" class="card pt-3">{% csrf_token %} 
            <div class="form-group row"> 
                {{ form.re_title|add_label_class:"col-form-label col-sm-2 ml-3 font-weight-bold" }} 
                <div class="col-sm-5"> 
                    {{ form.re_title|add_class:"form-control" }} 
                </div> 
            </div> 
            <div class="form-group row"> 
                {{ form.content|add_label_class:"col-form-label col-sm-2 ml-3 font-weight-bold" }} 
                <div class="col-sm-8"> 
                    {{ form.content|add_class:"form-control" }}
                </div> 
            </div>
            <div class="form-group"> 
                <div class="offset-sm-2 col-sm-5"> 
                    <input type="submit" value="리뷰 올리기" class="btn btn-info"/> 
                </div> 
            </div>
        </form> 
    </div>
</div>
<br><br><br><br><br>
{% endblock %}

{% block extra-script %} 
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script> 
    <script> 
        tinymce.init({ selector:'textarea', menubar: false, statusbar: false, toolbar1: 'formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify | numlist bullist outdent indent | removeformat' }); 
    </script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript">
        $(".like").click(function () { // .like 버튼을 클릭 감지
            var pk = $(this).attr('name')
            var target = $(this)
            $.ajax({ // ajax로 서버와 통신
                type: "POST", // 데이터를 전송하는 방법
                url: "{% url 'video:video_like' %}", // 통신할 url을 지정
                data: { 'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}' }, // 서버로 데이터 전송시 옵션, pk를 넘겨야 어떤 video인지 알 수 있음
                dataType: "json",
                success: function (response) { // 성공
                    console.log(response)
                    target.val("좋아요" + response.like_count + "개")
                    // $("#count-" + pk).html("좋아요&nbsp;" + response.likes_count + "개"); // 좋아요 개수 변경
                },
                error: function (request, status, error) { // 실패
                    alert("로그인이 필요합니다.")
                    window.location.replace("/accounts/login/") // 로그인 페이지로 넘어가기
                },
            });
        })
    </script>
    <script type="text/javascript">
        $(".dibs").click(function () { // .dibs 버튼을 클릭 감지
            var pk = $(this).attr('name')
            var target = $(this)
            $.ajax({ // ajax로 서버와 통신
                type: "POST", // 데이터를 전송하는 방법
                url: "{% url 'video:video_dibs' %}", // 통신할 url을 지정
                data: { 'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}' }, // 서버로 데이터 전송시 옵션, pk를 넘겨야 어떤 video인지 알 수 있음
                dataType: "json",
                success: function (response) { // 성공
                    // console.log(response)
                    target.val("찜하기" + response.message)
                },
                error: function (request, status, error) { // 실패
                    alert("로그인이 필요합니다.")
                    window.location.replace("/accounts/login/") // 로그인 페이지로 넘어가기
                },
            });
        })
    </script>
{% endblock %}
